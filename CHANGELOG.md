# Changelog

All notable changes to this project will be documented in this file.

## [1.4.5] – 2025-06-23
### Unreleased
- Конвертировать hex цвет в hsv, rgb

- Использовать MIN и MAX для значений из dp mapping, ибо в пересчете яркости в 0-100% получается ерунда какая-то для API ver 1

- При сканировании, если найдено многоканальное устройство отправлять в структуре инфу о кол-ве каналов

- Поддержка управления цветом во второй версии API

### Changed
- Если не обнаружено устройств в локальной сети при скане, то публикуем пустой словарь.

- Проделан большой функциональный рефакторинг, имеющий собой цель лучше локализовать зависимость от `tinytuta`. Нужно это, т.к. я более чем уверен, что в дальнейшем будет необходимо самим поддерживать эту библиотеку и придется делать, например, форк и локально ее обновлять и наполнять требуемым функционалом, т.к. в этом проекте приходится делать много разных штук, которые в идеале должны быть в этой библиотеке, а так приходится снаружи литы имплементировать требуемый функционал, типа функция тогл, при сканировании отдавать устройства по мере обнаружения и т.д. 

### Fixed
- Проверяем флаг остановки генераторных сканирований перед запуском, возможно могут быть ситуации, при которых флаг выставлен перед запуском сканирования, что не дает возможности запустить скан. Поэтому проверяем флаг, если выставлен, значит сбрасываем и запускем скан.

- При скане не отдавать в ответ устройства, которые присутствуют в `devices.json`

---

## [1.4.4] – 2025-06-16
### Unreleased
- Конвертировать hex цвет в hsv, rgb

- Использовать MIN и MAX для значений из dp mapping, ибо в пересчете яркости в 0-100% получается ерунда какая-то для API ver 1

- При сканировании, если найдено многоканальное устройство отправлять в структуре инфу о кол-ве каналов

- Поддержка управления цветом во второй версии API

### Added
- Добавлена функция `toggle` для устройств у которых есть булевые DP коды. Работает с `"api_ver": 2`. Например, `{"api_ver": 2, "switch_led": "toggle"}`. Можно "тоглить" более чем одну булевую штуку.

- Добавлен метод `_scan_gen_all_local_network` для топика `tuya2mqtt/bridge/request/scan_gen_all`, который накапливает все устройства в `all_results`, публикует полную карту найденных девайсов каждый раз при добавлении нового в топик `tuya2mqtt/bridge/response/scan_gen_all`, сохраняет результат в файл.

- Введен TTL для команд. Сделано так, что для команд управления TTL больше, чем для команды опроса статуса устройства, чтобы обеспечить как можно более быструю реакцию устройства на команды управления. Т.е. извлкаем из очереди содержимое и перед тем как отправить команду проверяем TTL, если он протух, то эта команда не уходит на устройство, а сразу переходим к следующим штукам в очереди. Таким образом не должно накапливаться ожидание ответов от устройств на старые накопившееся в очереди команды.

### Changed
- Сообщение об ошибках вида `{ "Error": "Network Error: Device Unreachable", "Err": "905", "Payload": null }` прибиты к нижнему регистру для единообразия, т.е. прибиты к нижнему регистру ключи таких сообщений, если они строковые.

---

## [1.3.4] – 2025-06-06
### Unreleased
- Функция toggle

- Ввести TTL для команд. Планируется сделать так, что для команд управления TTL будет больше, чем для команды опроса статуса устройства, чтобы обеспечить как можно более быструю реакцию устройства на команды управления.

- Конвертировать hex цвет в hsv, rgb

- Использовать MIN и MAX для значений из dp mapping, ибо в пересчете яркости в 0-100% получается ерунда какая-то для API ver 1

- При сканировании, если найдено многоканальное устройство отправлять в структуре инфу о кол-ве каналов

### Added
- Добавлен топик остановки сканирования для генераторной функции сканирования

- Добавлен топик, в который публикуется словарь со всеми статусами всех устройств, где ID устройств - ключ, статусы - значения

- Добавлена генераторная функция сканирования, которая возвращает данные по устройствам и публикует их в соответсвующий топик по мере обнаружения устройств

- Добавлена возможность через MQTT API использовать в командах управленияvчеловекочитаемые имена *Tuya DP* кодов, например `{"api_ver": 2, "switch_led": true, "switch": true}`, вместо `{"api_ver": 1, "switch": true, "switch": {"switch_num": 101, "state": true}}`

- При использовании `api_ver: 2` добавлен пересчет из диапазона 0-100% в туевый диапазон

### Changed
- В MQTT API для команд управления в словаре добавилось дополнительное (**но не обязательное**) поле `api_ver`. Прежняя версия API имеет номер `1`, новая соответственно `2`. Но если используется первая версия, ее можно не указывать, т.е. команда `{"api_ver": 1, "switch": true}` и `{"switch": true}` выполнятся одинаково.

---

## [1.2.4] – 2025-05-30
### Unreleased
- Функция toggle

- Проверить актуальность MQTT API документации

- Ввести TTL для команд. Планируется сделать так, что для команд управления TTL будет больше, чем для команды опроса статуса устройства, чтобы обеспечить как можно более быструю реакцию устройства на команды управления.

### Added
- Добавлена поддержка подключения к MQTT брокеру по логину и паролю. Если в переменных окружения заданы пользователь и пароль, то они будут использоваться при подключении к брокеру.

### Changed
- На запрос `scan` выполняется запрос к облаку для получения более полной информации об устройстве, ответ на запрос дополнился полями `"name", "product_name", "icon"`. Если Возникла ошибка при обращении к облаку по `ID` какого-то устройства, то в ответе по этому устройству есть поля `"Error", "Err", "Payload", "id"`.

- Вынесены *credentials* для нашего Tuya проекта в переменные окружения, а также данные для подключения к MQTT брокеру и пути к файлам `local_scan.json`, `devices.json`.

### Fixed
Исправлена ошибка - "При добавлении девайса пишет что он добавился в `local_scan.json`, хотя мы его добавляем в `devices.json`"

---

## [1.2.3] – 2025-05-29
### Unreleased
- Функция toggle

- Вынести *credentials* для нашего Tuya проекта в `.env`

- Проверить актуальность MQTT API документации

- Исправить ошибку - "При добавлении девайса пишет что он добавился в local_scan.json, хотя мы его добавляем в devices.json"

- Ввести TTL для команд. Планируется сделать так, что для команд управления TTL будет больше, чем для команды опроса статуса устройства, чтобы обеспечить как можно более быструю реакцию устройства на команды управления.

### Added
- Добавлен топик `tuya2mqtt/bridge/metrcis`, в который будут публиковаться метрики сервиса. На данный момент публикуюется информация об ошибках, какие ошибки и их кол-во относительно общего числа запроса статусов устройств. Кол-во медленных ответов (>5 сек)

- Добавлен реентерабельная блокировка потока для чтения/записи джсоновых конфигов.

### Changed
- Изменен подход к конкурентности. Раньше был один пул потоков, который обслуживал все потребности в управлении и получении статусов от устройств. Сейчас у каждого экземпляра устройства создается демонический поток, централизовано выполняющий все действия над устройством. Из потока бриджа команды в устройство поступают через приоритетную очередь. Фактически, демонический поток устройств просто разгружает очередь, выполняя полученные команды. А поток бриджа загружает в очередь команды через публичные методы `TuyaDevice`.

### Fixed
- Управление цветом не работало, т.к. не были удалены не актуальные участки кода в `tinytuya2mqtt.py`. Осуществлялась проверка с использованием словаря, которого уже нет в модуле `const.py`

- Исправлено поведение, когда устройство не реагирует на команды управления. Также после отправки команды управления мог подвисать опрос устройств. Происходило это из-за того, что на устройство отправлялись команды из разных потоков - команды опроса из одного потока, команды управления из другого. Библиотека `tinytuya` не умеет организовывать правильно подобные ситуации, она не потокобезопасна и на устройство могло отправиться одновременно и команда опроса и команда управления, отчего устройство может вести себя не предсказуемо - либо возвращались не валидные данные, либо оно могло не отвечать вовсе. С введением новой модели конкурентности данная проблема решилась - теперь все команды идут через приоритеную очередь, где команды управления имеет высший приоритет, чтобы обеспечивать как можно более быструю реакцию устройства на команды.

---

## [1.1.3] – 2025-05-14
### Unreleased
- Функция toggle

- Вынести *credentials* для нашего Tuya проекта в `.env`

- Проверить актуальность MQTT API документации

- Исправить ошибку - "При добавлении девайса пишет что он добавился в local_scan.json, хотя мы его добавляем в devices.json"

### Added
- Добавлен файл *THIRD-PARTY-LICENSES.md* с перечислением лицензий используемых библиотек, также в *README.md* коротко добавлена информация об либах и их лицензиях. Также добавлена директория *licenses* в которой приведены тексты лицензий для каждой библиотеки.

- Добавлено переподключение к MQTT брокеру, если не удалось подключиться к нему с первого раза, с выводом в лог причин почему не удалось подключиться с первого раза. Сервис будет все время пытаться переподключиться к брокеру, пока ему это не удастся.

- Добавлена обработка ошибок при добавлении устройство в сервис. Иногда, на запрос к облаку приходит ответ, содержащий ошибку и расплывчатое описание ошибки. Это может быть связано с некорректными настройками в проекте облака Tuya (например не добавлен iot-core сервис), не корректный ID устройства и т.д.

### Changed
- Ранее подписка на топики могла осуществляться еще до подключения к MQTT брокеру. Сейчас подписка осуществляется только после успешного подключения к брокеру.

## Fixed
- Добавлена обработка случая, когда у устройства за управления яркостью отвечает *DP code* "2".

- Добавлена обработка случая, когда во время парсинга принятых статусов с устройства в структуре содержатся *DP codes*, которых не было в полученной структуре из облака Tuya.

---

## [1.1.2] – 2025-05-14
### Added
- Добавлена поддержка настройки цветовой температуры.

- Реализована или почти реализована FSM. На текущий момент она отражает состояние транспорта, что данный сервис может быть подключен к сети интернет, подключен к сети без доступа в интернет и не иметь подключения к сети вовсе. Во всех этих состояниях сервис должен жить и выполнять методы, допустимые в каждом из состояний.

- Реализована обработка сигналов `SIGINT` и `SIGTERM`, при получении данных сигналов выполняется *gracefull shutdown*.

- Теперь `request` запросы будут возвращать в `response` ошибки, если в ходе обработки запроса что-то пошло не так. Пока формат не особо стандартизован.


### Changed
- При добавление устройства в сервис в возвращаемом ответе поле `"category"` теперь представлено в человекочитаемом формате в соответствии с документацией Tuya:
https://developer.tuya.com/en/docs/iot/lighting?id=Kaiuyzxq30wmc

- Изменен формат ответа при добавлении устройств. В ответный топик на команды *add* возвращается некий минимум данных по добавленному устройству, которого должно быть достаточно для его интерпретации на вызывающей стороне.

- Изменен формат документации MQTT API. Табличный формат не позволял опистаь более подробно все нюансы API.

- Изменены диапазоны значений для `"bright"` и `color_temp`, чтобы было 0-100, чтобы было единообразие диапазонов, т.к. для управления используются значения в процентах. 

- Изменен топик для публикации статусов с устройств. Был `tuya2mqtt/devices/+/state`, теперь `tuya2mqtt/devices/+/status`

- Решено отказаться от своего наименования Tuya DP - теперь используется то, как сами Tuya называют свои DP - ибо довольно трудоемко будет вести свою версию наменований, т.к. оно довольно сильно вариативно оказалось и ИМХО не стоит оно таких усилий.
---


## [0.1.1] – 2025-05-07
### Added
- При добавлении новых устройств проверяется предоставлен ли список ID. Поскольку ситуация, когда список ID устройств не предоставлен является недопустимой, то генерируется исключение и публикуется ответ в виде пустого словаря, что ни одно устройство добавлено не было, т.к. ни одного ID не было предоставлено.
- Добавлен ответ на запрос добавления списка устройств в сервис. В ответе в короткой форме представлен минимальный конфиг Tuya устройства, по которому можно интерпретировать его функционал и соформировать панельку в UI.

### Changed
- Исправлена ошибка, когда при наличиии `devices.json` мы хотим добавить устройства с конкретными ID, но добавляются при этом все устройства, которые есть в `local_scan.json`

---

## [0.1.0] – 2025-05-05

### Added
- Обнаружение устройств в локальной сети. Результат сканирования сохрантяется в `local_scan.json`, а также выдается в MQTT топик.

- Добавление устройств, чтобы сервис начал считывать данные с них и осуществлял управление через MQTT API. Для добавления устройств в MQTT топик передается ID устройств в списке. Результаты добавления сохраняется `devices.json`, где приводится вся информвция об каждом устройстве. При перезапуске сервиса этот файл используется для инициализации.

- Добавляются устрорйства типа `tinytuya.BulbDevice` и `tinytuya.Device` - различные светотехнические устройства и прочие.

- Для `tinytuya.BulbDevice` определены следующие возможности:
    - Включение и выключение;
    - Смена режима работы;
    - Изменение яркости;
    - Изменение цвета через RGB или HSV;
- Для `tinytuya.Device` определены следующие возможности:
    - Включение и выключение определеннго DP;

- Есть возможность задавать человекочитаемое имя устройства и использовать его для управления устройствами, в то же время можно использовать и device ID.

- При получении ошибки `ERR_KEY_OR_VER` автоматически происходит попытка запросить с облака *Tuya local key*.

- При получении ошибки `ERR_CONNECT` устройство удаляется из сервиса и в статусный топик этого устройства отправляется соответсвующая информация. Сделано так, чтобы не таймаутиться об него, т.к. эта ошибка встречается на данный момент ТОЛЬКО если устройство выключено или не подключено к WiFi.

- Команды управления устройствами можно комбинировать в JSON. Они будут выполняться в том порядке, в котором заданы в JSON строке. Чтобы это работало корректно сейчас установлена задержка 0.1 секунды после выполнения одной команды и перед выполнением другой. В противном случае устройство ведет себя не прогнозируемо.

---


